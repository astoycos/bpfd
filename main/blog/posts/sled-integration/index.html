
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      <link rel="icon" href="../../../img/favicon.svg">
      <meta name="generator" content="mkdocs-1.5.2, mkdocs-material-7.3.3">
    
    
      
        <title>bpfman's Shift Towards a Daemonless Design and Using Sled: a High Performance Embedded Database - bpfman</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.5143246d.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    
      


    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent="">
  
    
    <script>function __prefix(e){return new URL("../../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
      <script>var palette=__get("__palette");if(null!==palette&&"object"==typeof palette.color)for(var key in palette.color)document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#bpfmans-shift-towards-a-daemonless-design-and-using-sled-a-high-performance-embedded-database" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

  

<header class="md-header md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="bpfman" class="md-header__button md-logo" aria-label="bpfman" data-md-component="logo">
      
  <img src="../../../img/favicon.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            bpfman
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              bpfman's Shift Towards a Daemonless Design and Using Sled: a High Performance Embedded Database
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="custom" data-md-color-accent=""  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31z"/></svg>
            </label>
          
        
          
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="custom" data-md-color-accent=""  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/bpfman/bpfman" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../../.." class="md-tabs__link">
      Introduction
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../getting-started/building-bpfman/" class="md-tabs__link">
        Getting Started
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../governance/CONTRIBUTING/" class="md-tabs__link">
        Developer Guide
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../../governance/MEETINGS/" class="md-tabs__link">
        Community
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../" class="md-tabs__link">
        Blog
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="bpfman" class="md-nav__button md-logo" aria-label="bpfman" data-md-component="logo">
      
  <img src="../../../img/favicon.svg" alt="logo">

    </a>
    bpfman
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/bpfman/bpfman" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_2">
          Getting Started
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Getting Started" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Getting Started
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/building-bpfman/" class="md-nav__link">
        Setup and Building
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/running-release/" class="md-nav__link">
        Run bpfman From Release Image
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/tutorial/" class="md-nav__link">
        Bpfman on Linux Tutorial
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/cli-guide/" class="md-nav__link">
        CLI Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/example-bpf/" class="md-nav__link">
        Example eBPF Programs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/example-bpf-local/" class="md-nav__link">
        Deploying Example eBPF Programs On Local Host
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/example-bpf-k8s/" class="md-nav__link">
        Deploying Example eBPF Programs On Kubernetes
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../getting-started/troubleshooting/" class="md-nav__link">
        Troubleshooting
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_3">
          Developer Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Developer Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Developer Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/CONTRIBUTING/" class="md-nav__link">
        Contributing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/REVIEWING/" class="md-nav__link">
        Reviewing Guide
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/operator-quick-start/" class="md-nav__link">
        Deploying the bpfman-operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/develop-operator/" class="md-nav__link">
        Developing the bpfman-operator
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/api-spec/" class="md-nav__link">
        Kubernetes CRD API-Reference
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/shipping-bytecode/" class="md-nav__link">
        eBPF Bytecode Image Specifications
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/image-build/" class="md-nav__link">
        bpfman Container Images
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/documentation/" class="md-nav__link">
        Documentation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/linux-capabilities/" class="md-nav__link">
        Linux Capabilities
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/logging/" class="md-nav__link">
        Logging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/configuration/" class="md-nav__link">
        Configuration
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/testing/" class="md-nav__link">
        Testing
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/debugging/" class="md-nav__link">
        Debugging
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../developer-guide/release/" class="md-nav__link">
        Releasing
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
        
          
        
          
        
          
        
          
        
          
        
      
      
        <label class="md-nav__link" for="__nav_4">
          Community
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Community" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Community
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/MEETINGS/" class="md-nav__link">
        Meetings
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/GOVERNANCE/" class="md-nav__link">
        Governance
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/CODE_OF_CONDUCT/" class="md-nav__link">
        Code of Conduct
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/MAINTAINERS/" class="md-nav__link">
        Maintainers
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../../governance/SECURITY/" class="md-nav__link">
        Security
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
        
          
            
          
        
      
      
        
        
        <div class="md-nav__link md-nav__link--index ">
          <a href="../../">Blog</a>
          
        </div>
      
      <nav class="md-nav" aria-label="Blog" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Blog
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#why" class="md-nav__link">
    Why?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#why-sled" class="md-nav__link">
    Why Sled?
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#transitioning-to-sled" class="md-nav__link">
    Transitioning to Sled
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#tradeoffs" class="md-nav__link">
    Tradeoffs
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#moving-forward-and-getting-involved" class="md-nav__link">
    Moving forward and Getting Involved
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/bpfman/bpfman/edit/main/docs/blog/posts/sled-integration.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="bpfmans-shift-towards-a-daemonless-design-and-using-sled-a-high-performance-embedded-database">bpfman's Shift Towards a Daemonless Design and Using Sled: a High Performance Embedded Database</h1>
<p>As part of <a href="https://github.com/bpfman/bpfman/issues/860">issue #860</a> the community
has steadily been converting all of the internal state management to go through
a <a href="https://github.com/spacejam/sled">sled</a> database instance which is part of the larger effort to make
<a href="https://github.com/bpfman/bpfman/blob/main/docs/design/daemonless.md">bpfman completely damonless</a>.</p>
<p>This article will go over the reasons behind the change and dive into some
of the details of the actual implementation.</p>
<h2 id="why">Why?</h2>
<p>State management in bpfman has always been a headache, not
because there's a huge amount of disparate data but there's multiple
representations of the same data. Additionally the delicate filesystem
interactions and layout previously used to ensure persistence across restarts
often led to issues.</p>
<p>Understanding the existing flow of data in bpfman can help make this a bit clearer:</p>
<p><img alt="bpfman-data-flow" src="../img/2024-01-15/data-flow.png" /></p>
<p>With this design there was a lot of data wrangling required to convert the
tonic generated rust bindings for the protocol buffer API into data
structures that were useful for bpfman. Specifically, data would arrive
via GRPC server as specified in <code>bpfman.v1.rs</code> where rust types are inferred
from the protobuf definition. In <code>rpc.rs</code> data was then converted to an
internal set of structures defined in <code>command.rs</code>.  Prior to <a href="https://github.com/bpfman/bpfman/pull/683">pull request #683</a>
there was an explosion of types, with each bpfman command having it's own set of
internal structures and enums.  Now, most of the data for a program that bpfman
needs internally for all commands to manage an eBPF program is stored in
the <code>ProgramData</code> structure, which we'll take a deeper look at a bit later.
Additionally, there is extra complexity for XDP and TC program types
which rely on an eBPF dispatcher program to provide multi-program support on
a single network interface, however this article will try to instead focus
on the simpler examples.</p>
<p>The tree of data stored by bpfman is quite complex and this is made even more
complicated since bpfman has to be persistent across restarts.
To support this, raw data was often flushed to disk in the form of JSON files
(all types in <code>command.rs</code> needed to implement <a href="https://serde.rs/">serde's</a> <code>Serialize</code> and
<code>Deserialize</code>). Specific significance would also be encoded to bpfman's
directory structure, i.e all program related information was encoded in
<code>/run/bpfd/programs/&lt;ID&gt;</code>. The extra infrastructure and failure modes introduced
by this process was a constant headache, pushing the community to find a better
solution.</p>
<h2 id="why-sled">Why Sled?</h2>
<p><a href="https://github.com/spacejam/sled">Sled</a> is an open source project described in github as "the champagne of beta
embedded databases". The "reasons" for choosing an embedded database from the
<a href="https://github.com/spacejam/sled">project website</a> are pretty much spot on:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-0-1"></a><span class="nt">Embedded databases are useful in several cases</span><span class="p">:</span>
<a name="__codelineno-0-2"></a>
<a name="__codelineno-0-3"></a><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">you want to store data on disk, without facing the complexity of files</span>
<a name="__codelineno-0-4"></a><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">you want to be simple, without operating an external database</span>
<a name="__codelineno-0-5"></a><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">you want to be fast, without paying network costs</span>
<a name="__codelineno-0-6"></a><span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">using disk storage as a building block in your system</span>
</code></pre></div>
<p>As discussed in the previous section, persistence across restarts, is one of
bpfman's core design constraints, and with sled we <em>almost</em> get it for free!
Additionally due to the pervasive nature of data management to bpfman's core
workflow the data-store needed to be kept as simple and light weight as possible,
ruling out heavier production-ready external database systems such as MySQL or
Redis.</p>
<p>Now this mostly focused on why embedded dbs in general, but why did we choose
sled...well because it's written in :crab: Rust :crab: of course! Apart from the
obvious we took a small dive into the project before rewriting everything by
<a href="https://github.com/bpfman/bpfman/pull/861">transitioning the OCI bytecode image library</a>
to use the db rather than the filesystem.  Overall the experience was extremely
positive due to the following:</p>
<ul>
<li>No more dealing directly with the filesystem, the sled instance is flushed to
  the fs automatically every 500 ms by default and for good measure we manually
  flush it before shutting down.</li>
<li>The API is extremely simple, traditional get and insert operations function
  as expected.</li>
<li>Error handling with <code>sled:Error</code> is relatively simple and easy to map explicitly
  to a <code>bpfmanError</code></li>
<li>The db "tree" concept makes it easy to have separate key-spaces within the same
  instance.</li>
</ul>
<h2 id="transitioning-to-sled">Transitioning to Sled</h2>
<p>Using the new embedded database started with the creation of a sled instance
which could be easily shared across all of the modules in bpfman. To do this we
utilized a globally available [<code>lazy_static</code>] variable called <code>ROOT_DB</code> in
<code>main.rs</code>:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-1-1"></a><span class="cp">#[cfg(not(test))]</span><span class="w"></span>
<a name="__codelineno-1-2"></a><span class="n">lazy_static</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-1-3"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">ref</span><span class="w"> </span><span class="n">ROOT_DB</span>: <span class="nc">Db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-1-4"></a><span class="w">        </span><span class="p">.</span><span class="n">path</span><span class="p">(</span><span class="n">STDIR_DB</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-1-5"></a><span class="w">        </span><span class="p">.</span><span class="n">open</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-1-6"></a><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Unable to open root database&quot;</span><span class="p">);</span><span class="w"></span>
<a name="__codelineno-1-7"></a><span class="p">}</span><span class="w"></span>
<a name="__codelineno-1-8"></a>
<a name="__codelineno-1-9"></a><span class="cp">#[cfg(test)]</span><span class="w"></span>
<a name="__codelineno-1-10"></a><span class="n">lazy_static</span><span class="o">!</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-1-11"></a><span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">static</span><span class="w"> </span><span class="k">ref</span><span class="w"> </span><span class="n">ROOT_DB</span>: <span class="nc">Db</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Config</span>::<span class="n">default</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-1-12"></a><span class="w">        </span><span class="p">.</span><span class="n">temporary</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-1-13"></a><span class="w">        </span><span class="p">.</span><span class="n">open</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-1-14"></a><span class="w">        </span><span class="p">.</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;Unable to open temporary root database&quot;</span><span class="p">);</span><span class="w"></span>
<a name="__codelineno-1-15"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This block creates OR opens the filesystem backed database at <code>/var/lib/bpfman/db</code>
database only when the <code>ROOT_DB</code> variable is first accessed, and also allows for
the creation of a temporary db instance if running in unit tests. With this setup
all of the modules within bpfman can now easily access the database instance
by simply using it i.e <code>use crate::ROOT_DB</code>.</p>
<p>Next the existing bpfman structures needed to be flattened in order to work
with the db, the central <code>ProgramData</code> can be used to demonstrate how this was
completed. Prior to the recent sled conversion that structure looked like:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-2-1"></a><span class="sd">/// ProgramInfo stores information about bpf programs that are loaded and managed</span>
<a name="__codelineno-2-2"></a><span class="sd">/// by bpfd.</span>
<a name="__codelineno-2-3"></a><span class="cp">#[derive(Debug, Serialize, Deserialize, Clone, Default)]</span><span class="w"></span>
<a name="__codelineno-2-4"></a><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ProgramData</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-2-5"></a><span class="w">    </span><span class="c1">// known at load time, set by user</span>
<a name="__codelineno-2-6"></a><span class="w">    </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-7"></a><span class="w">    </span><span class="n">location</span>: <span class="nc">Location</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-8"></a><span class="w">    </span><span class="n">metadata</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-9"></a><span class="w">    </span><span class="n">global_data</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-10"></a><span class="w">    </span><span class="n">map_owner_id</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-11"></a>
<a name="__codelineno-2-12"></a><span class="w">    </span><span class="c1">// populated after load</span>
<a name="__codelineno-2-13"></a><span class="w">    </span><span class="n">kernel_info</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">KernelProgramInfo</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-14"></a><span class="w">    </span><span class="n">map_pin_path</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">PathBuf</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-15"></a><span class="w">    </span><span class="n">maps_used_by</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-16"></a>
<a name="__codelineno-2-17"></a><span class="w">    </span><span class="c1">// program_bytes is used to temporarily cache the raw program data during</span>
<a name="__codelineno-2-18"></a><span class="w">    </span><span class="c1">// the loading process.  It MUST be cleared following a load so that there</span>
<a name="__codelineno-2-19"></a><span class="w">    </span><span class="c1">// is not a long lived copy of the program data living on the heap.</span>
<a name="__codelineno-2-20"></a><span class="w">    </span><span class="cp">#[serde(skip_serializing, skip_deserializing)]</span><span class="w"></span>
<a name="__codelineno-2-21"></a><span class="w">    </span><span class="n">program_bytes</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-2-22"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This worked well enough, but as mentioned before the process of flushing the data
to disk involved manual serialization to JSON, which needed to occur at a specific
point in time (following program load) which made disaster recovery almost
impossible and could sometimes result in lost or partially reconstructed state.</p>
<p>With sled the first idea was to completely flatten ALL of bpfman's data into a
single key-space, so that <code>program.name</code> now simply turns into a <code>db.get("program_&lt;ID&gt;_name")</code>,
however removing all of the core structures would have resulted in a complex diff
which would have been hard to review and merge.  Therefore a more staged approach
was taken, the <code>ProgramData</code> structure was kept around, and now looks like:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-3-1"></a><span class="sd">/// ProgramInfo stores information about bpf programs that are loaded and managed</span>
<a name="__codelineno-3-2"></a><span class="sd">/// by bpfman.</span>
<a name="__codelineno-3-3"></a><span class="cp">#[derive(Debug, Clone)]</span><span class="w"></span>
<a name="__codelineno-3-4"></a><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ProgramData</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-3-5"></a><span class="w">    </span><span class="c1">// Prior to load this will be a temporary Tree with a random ID, following</span>
<a name="__codelineno-3-6"></a><span class="w">    </span><span class="c1">// load it will be replaced with the main program database tree.</span>
<a name="__codelineno-3-7"></a><span class="w">    </span><span class="n">db_tree</span>: <span class="nc">sled</span>::<span class="n">Tree</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-3-8"></a>
<a name="__codelineno-3-9"></a><span class="w">    </span><span class="c1">// populated after load, randomly generated prior to load.</span>
<a name="__codelineno-3-10"></a><span class="w">    </span><span class="n">id</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-3-11"></a>
<a name="__codelineno-3-12"></a><span class="w">    </span><span class="c1">// program_bytes is used to temporarily cache the raw program data during</span>
<a name="__codelineno-3-13"></a><span class="w">    </span><span class="c1">// the loading process.  It MUST be cleared following a load so that there</span>
<a name="__codelineno-3-14"></a><span class="w">    </span><span class="c1">// is not a long lived copy of the program data living on the heap.</span>
<a name="__codelineno-3-15"></a><span class="w">    </span><span class="n">program_bytes</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-3-16"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>All of the fields are now removed in favor of a private reference to the unique
[<code>sled::Tree</code>] instance for this <code>ProgramData</code> which is named using the unique
kernel id for the program. Each <code>sled::Tree</code> represents a single logical
key-space / namespace / bucket which allows key generation to be kept simple, i.e
<code>db.get("program_&lt;ID&gt;_name")</code> now can be <code>db_tree_prog_0000.get("program_name)</code>.
Additionally getters and setters are now built for each existing field so that
access to the db can be controlled and the serialization/deserialization process
can be hidden from the caller:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-4-1"></a><span class="p">...</span><span class="w"></span>
<a name="__codelineno-4-2"></a><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">BpfmanError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-4-3"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span><span class="w"></span>
<a name="__codelineno-4-4"></a><span class="p">}</span><span class="w"></span>
<a name="__codelineno-4-5"></a>
<a name="__codelineno-4-6"></a><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_name</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">BpfmanError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-4-7"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;name&quot;</span><span class="p">).</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="n">bytes_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">))</span><span class="w"></span>
<a name="__codelineno-4-8"></a><span class="p">}</span><span class="w"></span>
<a name="__codelineno-4-9"></a><span class="p">...</span><span class="w"></span>
</code></pre></div>
<p>Therefore, <code>ProgramData</code> is now less of a container for program data and more of a
wrapper for accessing program data.  The getters/setters act as a bridge
between standard Rust types and the raw bytes stored in the database,
i.e the [<code>sled::IVec</code> type].</p>
<p>Once this was completed for all the relevant fields on all the relevant types,
<a href="https://github.com/bpfman/bpfman/pull/874">see pull request #874</a>, the data bpfman needed for it's managed eBPF programs
was now automatically synced to disk :partying_face:</p>
<h2 id="tradeoffs">Tradeoffs</h2>
<p>All design changes come with some tradeoffs: for bpfman's conversion to using
sled the main negative ended up being with the complexity introduced with the [<code>sled::IVec</code> type].
It is basically just a thread-safe reference-counting pointer to a raw byte slice,
and the only type raw database operations can be performed with. Previously when
using <code>serde_json</code> all serialization/deserialization was automatically handled,
however with sled the conversion is manual handled internally. Therefore, instead
of a library handling the conversion of a rust string (<code>std::string::String</code>) to
raw bytes <code>&amp;[u8]</code> bpfman has to handle it internally, using [<code>std::string::String::as_bytes</code>]
and <code>bpfman::utils::bytes_to_string</code>:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-5-1"></a><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">bytes_to_string</span><span class="p">(</span><span class="n">bytes</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span><span class="w"></span>
<a name="__codelineno-5-2"></a><span class="w">    </span><span class="nb">String</span>::<span class="n">from_utf8</span><span class="p">(</span><span class="n">bytes</span><span class="p">.</span><span class="n">to_vec</span><span class="p">()).</span><span class="n">expect</span><span class="p">(</span><span class="s">&quot;failed to convert &amp;[u8] to string&quot;</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-5-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>For strings, conversion was simple enough, but when working with more complex rust
data types like <code>HashMaps</code> and <code>Vectors</code> this became a bit more of an issue.
For <code>Vectors</code>, we simply flatten the structure into a group of key/values with
indexes encoded into the key:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-6-1"></a><span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_kernel_map_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">map_ids</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">BpfmanError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-6-2"></a><span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">map_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">map_ids</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">i</span><span class="o">|</span><span class="w"> </span><span class="n">i</span><span class="p">.</span><span class="n">to_ne_bytes</span><span class="p">()).</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;&gt;</span><span class="p">();</span><span class="w"></span>
<a name="__codelineno-6-3"></a>
<a name="__codelineno-6-4"></a><span class="w">        </span><span class="n">map_ids</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">().</span><span class="n">try_for_each</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-6-5"></a><span class="w">            </span><span class="n">sled_insert</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">db_tree</span><span class="p">,</span><span class="w"> </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;kernel_map_ids_{i}&quot;</span><span class="p">).</span><span class="n">as_str</span><span class="p">(),</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-6-6"></a><span class="w">        </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-6-7"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The sled <code>scan_prefix(&lt;K&gt;)</code> api then allows for easy fetching and rebuilding of
the vector:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-7-1"></a><span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_kernel_map_ids</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">BpfmanError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-7-2"></a><span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">db_tree</span><span class="w"></span>
<a name="__codelineno-7-3"></a><span class="w">            </span><span class="p">.</span><span class="n">scan_prefix</span><span class="p">(</span><span class="s">&quot;kernel_map_ids_&quot;</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span><span class="w"></span>
<a name="__codelineno-7-4"></a><span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="w"> </span><span class="n">n</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="n">bytes_to_u32</span><span class="p">(</span><span class="n">v</span><span class="p">.</span><span class="n">to_vec</span><span class="p">())))</span><span class="w"></span>
<a name="__codelineno-7-5"></a><span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-7-6"></a><span class="w">                </span><span class="n">n</span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-7-7"></a><span class="w">                    </span><span class="n">BpfmanError</span>::<span class="n">DatabaseError</span><span class="p">(</span><span class="s">&quot;Failed to get map ids&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span><span class="w"></span>
<a name="__codelineno-7-8"></a><span class="w">                </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-7-9"></a><span class="w">            </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-7-10"></a><span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-7-11"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>For <code>HashMaps</code>, we follow a similar paradigm, except the map key is encoded in
the database key:</p>
<div class="highlight"><pre><span></span><code><a name="__codelineno-8-1"></a><span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_metadata</span><span class="p">(</span><span class="w"></span>
<a name="__codelineno-8-2"></a><span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-8-3"></a><span class="w">        </span><span class="n">data</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-8-4"></a><span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">BpfmanError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-5"></a><span class="w">        </span><span class="n">data</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">try_for_each</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-6"></a><span class="w">            </span><span class="n">sled_insert</span><span class="p">(</span><span class="w"></span>
<a name="__codelineno-8-7"></a><span class="w">                </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">db_tree</span><span class="p">,</span><span class="w"></span>
<a name="__codelineno-8-8"></a><span class="w">                </span><span class="n">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;metadata_{k}&quot;</span><span class="p">).</span><span class="n">as_str</span><span class="p">(),</span><span class="w"></span>
<a name="__codelineno-8-9"></a><span class="w">                </span><span class="n">v</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"></span>
<a name="__codelineno-8-10"></a><span class="w">            </span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-8-11"></a><span class="w">        </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-8-12"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a name="__codelineno-8-13"></a>
<a name="__codelineno-8-14"></a><span class="w">    </span><span class="k">pub</span><span class="p">(</span><span class="k">crate</span><span class="p">)</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">BpfmanError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-15"></a><span class="w">    </span><span class="bp">self</span><span class="p">.</span><span class="n">db_tree</span><span class="w"></span>
<a name="__codelineno-8-16"></a><span class="w">        </span><span class="p">.</span><span class="n">scan_prefix</span><span class="p">(</span><span class="s">&quot;metadata_&quot;</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-8-17"></a><span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-18"></a><span class="w">            </span><span class="n">n</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-19"></a><span class="w">                </span><span class="p">(</span><span class="w"></span>
<a name="__codelineno-8-20"></a><span class="w">                    </span><span class="n">bytes_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">k</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-8-21"></a><span class="w">                        </span><span class="p">.</span><span class="n">strip_prefix</span><span class="p">(</span><span class="s">&quot;metadata_&quot;</span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-8-22"></a><span class="w">                        </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-8-23"></a><span class="w">                        </span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<a name="__codelineno-8-24"></a><span class="w">                    </span><span class="n">bytes_to_string</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v</span><span class="p">).</span><span class="n">to_string</span><span class="p">(),</span><span class="w"></span>
<a name="__codelineno-8-25"></a><span class="w">                </span><span class="p">)</span><span class="w"></span>
<a name="__codelineno-8-26"></a><span class="w">            </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-8-27"></a><span class="w">        </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-8-28"></a><span class="w">        </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">n</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-29"></a><span class="w">            </span><span class="n">n</span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">e</span><span class="o">|</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a name="__codelineno-8-30"></a><span class="w">                </span><span class="n">BpfmanError</span>::<span class="n">DatabaseError</span><span class="p">(</span><span class="s">&quot;Failed to get metadata&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span><span class="w"></span>
<a name="__codelineno-8-31"></a><span class="w">            </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-8-32"></a><span class="w">        </span><span class="p">})</span><span class="w"></span>
<a name="__codelineno-8-33"></a><span class="w">        </span><span class="p">.</span><span class="n">collect</span><span class="p">()</span><span class="w"></span>
<a name="__codelineno-8-34"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>The same result could be achieved by creating individual database trees for
each <code>Vector</code>/<code>HashMap</code> instance, however our goal was to keep the layout
as flat as possible. Although this resulted in some extra complexity within the
data layer, the overall benefits still outweighed the extra code once the
conversion was complete.</p>
<h2 id="moving-forward-and-getting-involved">Moving forward and Getting Involved</h2>
<p>Once the conversion to sled is fully complete, see <a href="https://github.com/bpfman/bpfman/issues/860">issue #860</a>,
the project will be able to completely transition to becoming a library without
having to worry about data and state management.</p>
<p>If you are interested in in memory databases, eBPF, Rust, or any of the technologies
discussed today please don't hesitate to reach out on [kubernetes slack at <code>#bpfman</code>]
or join one of the <a href="[https://bpfman.io/main/governance/meetings/]">community meetings</a> to get involved.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2021-2023 The bpfman contributors
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.indexes", "navigation.tabs", "navigation.tabs.sticky", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.8397ff9e.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "version": {"provider": "mike"}}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f89c2efe.min.js"></script>
      
    
  </body>
</html>